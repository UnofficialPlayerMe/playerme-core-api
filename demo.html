<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>API Test Page</title>

    <script src="dist/playerme.models.js"></script>
    <script src="dist/playerme.api.js"></script>

    <script>
        function onLoad(){
            listModules();
        }

        function listModules() {
            // Log library
            console.log("PlayerMe", PlayerMe);

            // Get model list
            var apiList = document.getElementById("apiList");

            // List models
            for (var key in PlayerMe.API) {
                var apiObject = PlayerMe.API[key];
                var instance = null;
                var properties = [];
                var type = typeof apiObject;

                switch (typeof apiObject){
                    case 'function':
                        if (apiObject.name) type = apiObject.name;
                        instance = new apiObject;
                        properties = Object.getOwnPropertyNames(apiObject.prototype);
                        break;
                    case 'object':
                        type = Object.getPrototypeOf(apiObject).constructor.name;
                        instance = apiObject;
                        properties = Object.getOwnPropertyNames(apiObject);
                        break;
                }

                // Add to list
                var listItem = document.createElement("LI");
                listItem.innerHTML = "<h3 style='margin-bottom:0'>"+
                        key + " : <span style='color:grey'>"+type+"</span>"+
                        "</h3>";
                apiList.appendChild(listItem);

                // List members
                var subList = document.createElement("UL");
                for (var i in properties) {
                    var prop = properties[i];
                    var propType = Object.getPrototypeOf(instance[prop]).constructor.name;

                    var listSubItem = document.createElement("LI");
                    listSubItem.innerHTML = prop+" : <span style='color:grey'>"+propType+"</span>";
                    subList.appendChild(listSubItem);
                    listItem.appendChild(subList);
                }
            }
        } // End of onLoad

        function alertObject(title, obj){
            var body = '';
            for (var key in obj){
                body += '\n\n' + key +": \n" + JSON.stringify(obj[key]);
            }
            alert(title+body);
        }

        function clickedRequest(url){
            var data = null;
            console.log("GET", url, data);

            try {
                var promise = PlayerMe.API.APIService.get(url, data);
            } catch(e) {
                console.error(e);
                alertObject('Error', e);
                return;
            }

            promise.then(function(payload){
                console.log(payload);
                var title =
                    payload.method + " " +
                    payload.uri + " " +
                    (payload.success ? "(success)" : "(failure)")
                ;
                alertObject(title, payload);
            });
        }

        function clickedUsersRepository(id){
            try {
                var promise = PlayerMe.API.UsersRepository.get(id);
                promise.then(function(payload){
                    console.log(payload);
                    alertObject('UsersRepository.get('+id+')', payload);
                })
            }catch(e){
                console.error(e);
                alertObject('Error', e);
                return;
            }
        }
    </script>

</head>
<body onload="onLoad()">

<h1>API Test Page</h1>

<h2>Test Actions</h2>
<p>
    <button onclick="clickedRequest('api/v1/feed')">Request Feed</button>
    <button onclick="clickedRequest('api/v1/users/default')">Request User</button>
</p>
<p>
    <button onclick="clickedUsersRepository(1)">UsersRepository GET</button>
</p>

<h2>Module Members</h2>
<ul id="apiList"></ul>

</body>
</html>
